<!doctype html>
<html land="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">


<th:block th:fragment="commonHead">
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Common CSS -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/library/bootstrap/bootstrap.min.css" />
    <link rel="stylesheet" href="/library/fontawesome/css/all.min.css">
    <style>
        .container{
            max-width: 100%;
            padding: 0;
        }
        html{
            padding-bottom: 100px;
        }
        .list-group-item{
            width: 160px;
            height: 40px;
            padding: 7px;
        }
        .modal-dialog{
            margin-top: 150px;
        }
        #notificationDeleteButton{
            color: gray;
        }
        #notificationDeleteButton:hover{
            color: black;
        }
        .notificationContent{
            width: 402px;
            height: 131px;
        }
        .notificationLink{
            text-align: left;
            width: 350px;
            height: 116px;
        }
        #userNameAndNicknameDropdownMenu{
            height: 70px;
            padding-top: 6px;
        }
        .userDropdownMenu{
            height: 43px;
        }
        .userAllDropdownMenu{
            padding: 0;
            width: 143px;
        }
        .userDropdownItem{
            padding-top: 9px;
            padding-bottom: 9px;
        }
        #userIconArrow{
            margin-left: 3px;
            margin-right: 6px;
            color: gray;
        }
    </style>
    <title>TH</title>
</th:block>

<div th:fragment="commonNav">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <!-- 타임리프로 랜더링 할 때, href에 들어갈 값을 "@{/}" 값으로 바꿔준다. -->
        <!-- 타임리프가 알아서 경로 등 치환해줘서 편함. -->
        <!-- 타임리프로 랜더링 하지 않을 때는 순수 href값을 사용-->
        <!-- 사실 타임리프로 랜더링 되지 않을 때, 순수 HTML을 사용할 때 사용할 값을 href="#"와 같이 줘야 한다. -->
        <a class="navbar-brand" href="/" th:href="@{/}" style="margin-left: 3px">TH</a>

        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo02" aria-controls="navbarTogglerDemo02" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse flex-row-reverse" id="navbarTogglerDemo02">
            <ul class="navbar-nav justify-content-end" style="margin-right: 64px;">
                <li class="nav-item" sec:authorize="!isAuthenticated()" style="margin-right: 15px;">
                    <a class="nav-link" th:href="@{/login}">로그인</a>
                </li>
                <li class="nav-item" sec:authorize="!isAuthenticated()">
                    <a class="nav-link" th:href="@{/sign-up}">회원가입</a>
                </li>
                <li class="nav-item" sec:authorize="isAuthenticated()">
                    <a class="nav-link btn btn-outline-info" type="button" th:href="@{/post-new-post}"
                       style="padding-top: 6px;padding-bottom: 6px;margin-right: 60px;">
                        <i class="fas fa-plus" style="padding-right: 2px"></i> 게시글 작성
                    </a>
                </li>

                <li class="nav-item" sec:authorize="isAuthenticated()" style="padding-top: 10px">
                        <a id="notificationBell" href="javascript:notificationBellClick();" style="cursor: pointer;margin-right: 43px">
                        <span th:if="${allNotification.size() == 0}" class="text-dark">
                            <i class="far fa-bell fa-lg"></i>
                        </span>
                        <span th:if="${allNotification.size() >= 1}" class="text-danger">
                            <i class="fas fa-bell fa-lg"></i><span id="notificationCountBadge" class="badge badge-pill badge-danger" th:text="${allNotification.size()}"
                                                                   style="position: absolute;z-index: 5;top: 12px;right: 183px;"></span>
                        </span>
                        </a>

                        <div th:if="${allNotification.size() == 0}" class="card" id="notificationList" style="position: absolute;z-index: 10;top: 52px;right: 158px;display: none;">
                            <div class="card-body text-center text-muted" style="padding: 7px 21px">
                                알림이 없습니다.
                            </div>
                        </div>

                        <div th:if="${allNotification.size() >= 1}" id="notificationList" style="position: absolute;z-index: 10;top: 52px;right:145px;display: none;max-height: 850px;overflow-y: auto">
                            <ul class="list-group">
                                <li th:id="'notificationContent' + ${notification.id}" class="list-group-item notificationContent" th:each="notification : ${allNotification}">
                                    <div style="float: left;">
                                        <a th:href="@{${notification.link}}" class="btn btn-light notificationLink">
                                                <span th:if="${notification.notificationType == T(portfolio2.module.notification.NotificationType).NEW_POST_WITH_MY_INTEREST_TAG_IS_POSTED ||
                                                            notification.notificationType == T(portfolio2.module.notification.NotificationType).MY_INTEREST_TAG_IS_ADDED_TO_UPDATED_POST}">
                                                회원님의 관심 태그들 중,
                                                </span>
                                                <br>
                                                <span class="d-inline-block text-truncate" style="max-width: 300px;">
                                                    <span th:if="${notification.notificationType == T(portfolio2.module.notification.NotificationType).NEW_POST_WITH_MY_INTEREST_TAG_IS_POSTED ||
                                                            notification.notificationType == T(portfolio2.module.notification.NotificationType).MY_INTEREST_TAG_IS_ADDED_TO_UPDATED_POST}"
                                                          style="font-weight: bold" th:each="tag : ${notification.commonTag}">
                                                    <span th:text="${tag.getTitle()}"></span>
                                                    <span th:if="${#bools.isFalse(tagStat.last)}">,</span>
                                                    </span>
                                                </span>
                                                <br>

                                                <span th:if="${notification.notificationType == T(portfolio2.module.notification.NotificationType).NEW_POST_WITH_MY_INTEREST_TAG_IS_POSTED}">
                                                의 태그가 포함된 게시물이 게시되었습니다!
                                                </span>
                                                <span th:if="${notification.notificationType == T(portfolio2.module.notification.NotificationType).MY_INTEREST_TAG_IS_ADDED_TO_UPDATED_POST}">의 태그가 기존 게시물에 추가되었습니다!
                                                </span>
                                                <br>
                                                <span class="d-inline-block text-truncate" style="font-weight: bold">"</span>
                                                <span class="d-inline-block text-truncate" style="font-weight: bold;max-width: 300px" th:text="${notification.title}"></span>
                                                <span class="d-inline-block text-truncate" style="font-weight: bold">"</span>
                                        </a>
                                        <div id="notificationDeleteButton" th:onclick="'javascript:deleteNotification(' + ${notification.id} + ');'" style="position: absolute; cursor:pointer;top: 9px;right: 20px;" onclick="notificationDelete()">
                                            <i class="fas fa-times"></i>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                </li>

                <li class="nav-item" sec:authorize="isAuthenticated()" style="margin-left: 9px;">
                    <div id="userIcon" onclick="userIconClick()" onmouseover="userIconMouseOver()" onmouseout="userIconMouseOut()" style="margin-right: 6px; cursor: pointer">
                        <svg th:if="${#strings.isEmpty(sessionAccount?.profileImage)}" th:data-jdenticon-value="${#authentication.name}"
                                 width="39" height="39" class="rounded border bg-light"></svg>
                        <img th:if="${!#strings.isEmpty(sessionAccount?.profileImage)}" th:src="${sessionAccount.profileImage}"
                                 width="39" height="39" class="rounded border"/>
                        <span id="userIconArrow"><i class="fas fa-sort-down"></i></span>
                    </div>
                    <div id="userMenu" class="text-center" style="position:absolute;top: 52px;right: 82px;z-index: 10;display: none">
                        <ul class="list-group">
                            <li class="list-group-item userAllDropdownMenu" id="userNameAndNicknameDropdownMenu">
                                <span class="d-inline-block text-truncate" style="max-width: 110px" sec:authentication="name" ></span>
                                <br>
                                <span class="d-inline-block text-truncate">(</span>
                                <span class="d-inline-block text-truncate" style="max-width: 110px" th:text="${sessionAccount.nickname}"></span>
                                <span class="d-inline-block text-truncate">)</span>
                            </li>
                            <li class="list-group-item userDropdownMenu userAllDropdownMenu">
                                <a class="dropdown-item userDropdownItem" th:href="@{'/account/profile-view/' + ${#authentication.name}}">프로필</a>
                            </li>
                            <li class="list-group-item userDropdownMenu userAllDropdownMenu">
                                <a class="dropdown-item userDropdownItem" th:href="@{'/account/post/' + ${#authentication.name}}">내 게시글</a>
                            </li>
                            <li class="list-group-item userDropdownMenu userAllDropdownMenu">
                                <a class="dropdown-item userDropdownItem" href="#" th:href="@{/account/setting/profile}">설정</a>
                            </li>
                            <li class="list-group-item userDropdownMenu userAllDropdownMenu">
                                <form class="form-inline my-2 my-lg-0" action="#" th:action="@{/logout}" method="post">
                                    <button class="dropdown-item userDropdownItem" type="submit">로그아웃</button>
                                </form>
                            </li>
                        </ul>
                    </div>
                </li>
            </ul>

            <ul class="navbar-nav" style="margin-right: 28px">
                <li class="nav-item">
                    <form th:action="@{/search/post}" class="form-inline" method="get">
                        <input class="form-control" name="keyword" type="search" aria-label="Search" style="width: 170px;margin-right: 30px"/>
                        <button class="btn btn-outline-success my-2 my-sm-0" type="submit">검색</button>
                    </form>
                </li>
            </ul>

        </div>
    </nav>

    <div sec:authorize="isAuthenticated()" class="alert alert-warning text-center" role="alert" th:if="${sessionAccount != null && #bools.isFalse(sessionAccount.isEmailVerified())}">
        <a href="#" th:href="@{/account/setting/account}" class="alert-link">이메일 인증</a>을 해야 이메일로 비밀번호 찾기, 이메일 알림 등 이메일을 통한 서비스를 받으실 수 있습니다.
    </div>

</div>

<footer th:fragment="commonFooter" style="text-align: center; color: #6c757d; margin-top: 40px">
    © 2020 Copyright : taehee.kim.dev@gmail.com
</footer>

<th:block th:fragment="commonJavaScript">
    <script src="/library/jquery/jquery-3.5.1.min.js"></script>
    <script src="/library/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="/library/jdenticon/jdenticon-2.2.0.min.js"></script>
    <script type="application/javascript">
        function deleteNotification(notificationId) {
            $.ajax({
                autocomplete: {
                    enabled: true,
                    rightKey: true,
                },
                contentType: "application/json; charset=utf-8",
                method: "POST",
                url: "/notification/delete",
                data: JSON.stringify({'notificationIdToDelete': notificationId})
                }).done(function () {
                    $("#notificationContent" + notificationId).fadeOut(300,
                        function(){
                            $(this).remove();
                        }
                    );
                    let currentNotificationCount = document.getElementById("notificationCountBadge").innerText;
                    let count = parseInt(currentNotificationCount);
                    document.getElementById("notificationCountBadge").innerText = count.toString(10);
                });
            }
    </script>
    <script type="application/javascript">
        const notificationList = document.getElementById("notificationList");
        const notificationBell = document.getElementById("notificationBell");
        window.addEventListener('click', function(e){
            if(notificationList !== null){
                if (!notificationBell.contains(e.target)
                    && !notificationList.contains(e.target)){
                    notificationList.style.display = "none";
            }
        }});
        function notificationBellClick(){
            if (notificationList.style.display === "none") {
                notificationList.style.display = "";
            } else if (notificationList.style.display === "") {
                notificationList.style.display = "none";
            }
        }
    </script>
    <script type="application/javascript">
        const userIcon = document.getElementById("userIcon");
        const userMenu = document.getElementById("userMenu");
        window.addEventListener('click', function(e){
            if(userMenu !== null){
                if (!userIcon.contains(e.target)
                    && !userMenu.contains(e.target)){
                    userMenu.style.display = "none";
                }
            }
        });
        function userIconClick(){
            if (userMenu.style.display === "none") {
                userMenu.style.display = "";
            } else if (userMenu.style.display === "") {
                userMenu.style.display = "none";
            }
        }

        const userIconArrow = document.getElementById("userIconArrow");
        function userIconMouseOver(){
            userIconArrow.style.color = 'black';
        }
        function userIconMouseOut(){
            userIconArrow.style.color = 'gray';
        }
    </script>
    <script type="application/javascript" th:inline="javascript" th:fragment="ajax-csrf-header">
        $(function() {
            var csrfToken = /*[[${_csrf.token}]]*/ null;
            var csrfHeader = /*[[${_csrf.headerName}]]*/ null;
            $(document).ajaxSend(function (e, xhr, options) {
                xhr.setRequestHeader(csrfHeader, csrfToken);
            });
        });
    </script>
</th:block>



<div th:fragment="setting-menu (currentMenu)" class="list-group" style="text-align: center; width: 160px; margin-right: 75px">
    <a class="list-group-item list-group-item-action" th:classappend="${currentMenu == 'profile'}? active" href="#" th:href="@{/account/setting/profile}">프로필</a>
    <a class="list-group-item list-group-item-action" th:classappend="${currentMenu == 'notification'}? active" href="#" th:href="@{/account/setting/notification}">알림</a>
    <a class="list-group-item list-group-item-action" th:classappend="${currentMenu == 'tag'}? active" href="#" th:href="@{/account/setting/tag}">관심 태그</a>
    <a class="list-group-item list-group-item-action" th:classappend="${currentMenu == 'password'}? active" href="#" th:href="@{/account/setting/password}">패스워드</a>
    <a class="list-group-item list-group-item-action list-group-item-danger" th:classappend="${currentMenu == 'account'}? active" href="#" th:href="@{/account/setting/account}">계정</a>
</div>

<div th:fragment="date-time">
    <script src="/library/momentjs/moment-with-locales.min.js"></script>
    <script type="application/javascript">
        $(function () {
            moment.locale('ko');
            $(".date-weekday-time").text(function(index, dateTime) {
                return moment(dateTime, "YYYY-MM-DD`T`hh:mm").format('LLLL');
            });
        })
    </script>
</div>